<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n de Noticias</title>
    
    <!-- NEW: Add headers to enable SharedArrayBuffer, fixing the error -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Using a modern FFmpeg version again -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal, .video-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal.hidden, .video-modal.hidden { display: none; }
        .modal-container, .video-modal-container { 
            transition: transform 0.3s ease-in-out; 
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600">Panel de Noticias</h1>
            <div>
                <button style="display: none;" id="initial-load-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cargar JSON Inicial</button>
                <button id="add-news-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">A√±adir Noticia</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div id="loading" class="text-center py-10">
            <p class="text-lg text-gray-600">Cargando noticias desde Firebase...</p>
        </div>
        <div id="news-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>
    </main>
    
    <!-- News Edit/Add Modal -->
    <div id="news-modal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="modal-overlay fixed inset-0"></div>
        <div class="modal-container bg-white rounded-lg shadow-xl w-11/12 md:max-w-3xl mx-auto z-50 transform -translate-y-10">
            <div class="p-6">
                <div class="flex justify-between items-start">
                    <h2 id="modal-title" class="text-2xl font-bold mb-4">A√±adir Nueva Noticia</h2>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-4">
                    <h3 class="font-bold text-blue-800">Generar con IA ü§ñ</h3>
                    <p class="text-sm text-blue-700 mb-2">Escribe un tema o titular y la IA investigar√°, planificar√° y redactar√° la noticia por ti.</p>
                    <input type="text" id="ai-topic" placeholder="Ej: El puerto de Motril bate r√©cords" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center p-1 bg-gray-200 rounded-lg space-x-1">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="generation-mode" id="mode-news" class="sr-only peer" checked>
                                <span class="px-3 py-1 text-sm font-semibold rounded-md peer-checked:bg-white peer-checked:shadow transition-all duration-300">Noticia</span>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="generation-mode" id="mode-article" class="sr-only peer">
                                <span class="px-3 py-1 text-sm font-semibold rounded-md peer-checked:bg-white peer-checked:shadow transition-all duration-300">Art√≠culo</span>
                            </label>
                        </div>
                        <button type="button" id="generate-ai-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center min-w-[120px]">
                            <span id="ai-btn-text">Generar</span>
                            <div id="ai-loader" class="loader ml-2 hidden"></div>
                        </button>
                    </div>
                </div>

                <form id="news-form" class="space-y-4">
                     <!-- Form fields remain the same -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="titulo" placeholder="T√≠tulo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="text" id="categoria" placeholder="Categor√≠a" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <input type="text" id="autor" placeholder="Autor" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <input type="date" id="fecha" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <input type="text" id="imagen" placeholder="URL de la Imagen" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <select id="estado" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="publicado">Publicado</option>
                            <option value="borrador">Borrador</option>
                        </select>
                    </div>
                    <textarea id="resumen" placeholder="Resumen" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></textarea>
                    <textarea id="contenido" placeholder="Contenido (HTML)" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></textarea>
                    <div class="text-right">
                        <button type="button" id="cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Video Generation Modal -->
    <div id="video-modal" class="video-modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="video-modal-container bg-white rounded-lg shadow-xl w-11/12 md:max-w-md mx-auto z-50 p-6 text-center">
            <h2 class="text-2xl font-bold mb-4">Creando Short de Video üé¨</h2>
            <div id="video-loader" class="loader mx-auto my-4" style="width: 50px; height: 50px; border-top-color: #4f46e5;"></div>
            <p id="video-progress-text" class="text-lg text-gray-700">Iniciando proceso...</p>
            <div id="video-output" class="mt-4"></div>
            <button id="close-video-modal-btn" class="hidden mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfK_AOq-Pc2bzgXEzIEZ1ESWvnhMJUvwI",
            authDomain: "enraya-51670.firebaseapp.com",
            databaseURL: "https://enraya-51670-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "enraya-51670",
            storageBucket: "enraya-51670.firebasestorage.app",
            messagingSenderId: "103343380727",
            appId: "1:103343380727:web:b2fa02aee03c9506915bf2",
            measurementId: "G-2G31LLJY1T"
        };
        
        const GEMINI_API_KEY = "AIzaSyAsNaND7sFvxAFyAKASUdXhkH6goiJOZ7s";
        const GOOGLE_SEARCH_API_KEY = "AIzaSyBppsbpyFv647_fnFOmlw9RgwROwz-aVlY";
        const GOOGLE_SEARCH_CX = "6778d5bd655094965";
        const UNSPLASH_API_KEY = "VbJ9cEbyofis4p1aNQE4ADO2KyZqA8gQGVtOKRe6nbs";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const newsRef = ref(db, 'noticias');

        let currentEditingId = null;

        // --- DOM Elements ---
        const newsList = document.getElementById('news-list');
        const loading = document.getElementById('loading');
        const modal = document.getElementById('news-modal');
        const form = document.getElementById('news-form');
        const videoModal = document.getElementById('video-modal');
        const videoProgressText = document.getElementById('video-progress-text');
        const videoLoader = document.getElementById('video-loader');
        const videoOutput = document.getElementById('video-output');
        const closeVideoModalBtn = document.getElementById('close-video-modal-btn');
        const aiTopicInput = document.getElementById('ai-topic');
        const generateAiBtn = document.getElementById('generate-ai-btn');
        const aiBtnText = document.getElementById('ai-btn-text');
        const aiLoader = document.getElementById('ai-loader');


        function slugify(text) {
            const a = '√†√°√¢√§√¶√£√•ƒÅƒÉƒÖ√ßƒáƒçƒëƒè√®√©√™√´ƒìƒóƒôƒõƒü«µ·∏ß√Æ√Ø√≠ƒ´ƒØ√¨≈Ç·∏ø√±≈Ñ«π≈à√¥√∂√≤√≥≈ì√∏≈ç√µ≈ë·πï≈ï≈ô√ü≈õ≈°≈ü»ô≈•»õ√ª√º√π√∫≈´«ò≈Ø≈±≈≥·∫É·∫ç√ø√Ω≈æ≈∫≈º¬∑/_,:;'
            const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
            const p = new RegExp(a.split('').join('|'), 'g')
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-') .replace(p, c => b.charAt(a.indexOf(c)))
                .replace(/&/g, '-and-').replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
        }

        onValue(newsRef, (snapshot) => {
            loading.style.display = 'none';
            newsList.innerHTML = '';
            const data = snapshot.val();
            if (data) {
                Object.values(data)
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                    .forEach(noticia => newsList.appendChild(createNewsCard(noticia)));
            } else {
                newsList.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay noticias.</p>';
            }
        });
        
        function createNewsCard(noticia) {
            const card = document.createElement('div');
            card.className = "bg-white rounded-lg shadow-lg overflow-hidden flex flex-col";
            // MODIFIED: Use the CORS proxy for displaying images on the cards
            const proxiedImageUrl = `https://corsproxy.io/?${encodeURIComponent(noticia.imagen)}`;
            card.innerHTML = `
                <img class="h-48 w-full object-cover" src="${proxiedImageUrl}" alt="${noticia.titulo}">
                <div class="p-6 flex flex-col flex-grow">
                    <div class="flex-grow">
                        <span class="text-xs font-semibold ${noticia.estado === 'publicado' ? 'text-green-600 bg-green-100' : 'text-yellow-600 bg-yellow-100'} py-1 px-2 rounded-full">${noticia.estado}</span>
                        <h3 class="font-bold text-xl my-2">${noticia.titulo}</h3>
                        <p class="text-gray-600 text-sm">${noticia.resumen}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 flex justify-end space-x-2">
                        <button class="create-short-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Crear Short</button>
                        <button class="edit-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-3 rounded-lg text-sm">Editar</button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Eliminar</button>
                    </div>
                </div>`;
            card.querySelector('.edit-btn').addEventListener('click', () => handleEdit(noticia));
            card.querySelector('.delete-btn').addEventListener('click', () => handleDelete(noticia.id, noticia.titulo));
            card.querySelector('.create-short-btn').addEventListener('click', () => handleCreateShort(noticia));
            return card;
        }

        // --- Modal Handling ---
        const openModal = () => modal.classList.remove('hidden');
        const closeModal = () => modal.classList.add('hidden');
        const openVideoModal = () => {
            videoProgressText.textContent = 'Iniciando proceso...';
            videoLoader.classList.remove('hidden');
            videoOutput.innerHTML = '';
            closeVideoModalBtn.classList.add('hidden');
            videoModal.classList.remove('hidden');
        };
        const closeVideoModal = () => videoModal.classList.add('hidden');
        
        closeVideoModalBtn.addEventListener('click', closeVideoModal);
        document.getElementById('add-news-btn').addEventListener('click', () => {
            form.reset();
            currentEditingId = null; 
            document.getElementById('modal-title').innerText = 'A√±adir Nueva Noticia';
            document.getElementById('fecha').valueAsDate = new Date();
            openModal();
        });
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        modal.querySelector('.modal-overlay').addEventListener('click', closeModal);

        function handleEdit(noticia) {
            currentEditingId = noticia.id;
            document.getElementById('modal-title').innerText = 'Editar Noticia';
            document.getElementById('titulo').value = noticia.titulo;
            document.getElementById('categoria').value = noticia.categoria;
            document.getElementById('autor').value = noticia.autor;
            document.getElementById('fecha').value = noticia.fecha;
            document.getElementById('imagen').value = noticia.imagen;
            document.getElementById('estado').value = noticia.estado;
            document.getElementById('resumen').value = noticia.resumen;
            document.getElementById('contenido').value = noticia.contenido;
            openModal();
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const titulo = document.getElementById('titulo').value.trim();
            if (!titulo) {
                alert('El t√≠tulo es obligatorio.');
                return;
            }
            const newId = slugify(titulo); 
            const noticiaData = {
                id: newId,
                titulo: document.getElementById('titulo').value,
                categoria: document.getElementById('categoria').value,
                autor: document.getElementById('autor').value,
                fecha: document.getElementById('fecha').value,
                imagen: document.getElementById('imagen').value,
                estado: document.getElementById('estado').value,
                resumen: document.getElementById('resumen').value,
                contenido: document.getElementById('contenido').value,
            };
            const processSave = () => {
                set(ref(db, `noticias/${newId}`), noticiaData).then(() => {
                    if (currentEditingId && currentEditingId !== newId) {
                        remove(ref(db, `noticias/${currentEditingId}`));
                    }
                    closeModal();
                }).catch(err => alert('Error al guardar: ' + err.message));
            };
            if (newId !== currentEditingId) {
                 get(ref(db, `noticias/${newId}`)).then(snapshot => {
                    if (snapshot.exists()) {
                        alert('Error: Ya existe una noticia con un t√≠tulo similar. Por favor, elige un t√≠tulo √∫nico.');
                    } else {
                        processSave();
                    }
                });
            } else {
                processSave();
            }
        });

        function handleDelete(id, titulo) {
             if (confirm(`¬øEst√°s seguro de que quieres eliminar "${titulo}"?`)) {
                remove(ref(db, `noticias/${id}`)).then(() => alert('Noticia eliminada.'));
            }
        }
        
        // --- AI Text Generation Logic ---
        const updateAiButtonState = (text, isLoading) => {
            aiBtnText.textContent = text;
            aiBtnText.classList.toggle('hidden', isLoading);
            aiLoader.classList.toggle('hidden', !isLoading);
            generateAiBtn.disabled = isLoading;
        };

        const callGeminiAPI = async (prompt) => {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`Error en la API de Gemini: ${response.statusText} - ${errorBody}`);
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        };

        const parseJsonResponse = (text, type) => {
            const jsonMatch = text.match(/{[\s\S]*}/);
            if (!jsonMatch) throw new Error(`La IA no devolvi√≥ un JSON v√°lido para '${type}'.`);
            try {
                return JSON.parse(jsonMatch[0]);
            } catch (e) {
                 throw new Error(`Error al parsear el JSON para '${type}': ${e.message}`);
            }
        };

        generateAiBtn.addEventListener('click', async () => {
            const topic = aiTopicInput.value.trim();
            if (!topic) {
                alert('Por favor, introduce un tema para la noticia.');
                return;
            }
            const isNewsMode = document.getElementById('mode-news').checked;

            try {
                updateAiButtonState('Pensando...', true);
                const searchGenPrompt = `Para el tema "${topic}", genera 5 consultas de b√∫squeda para Google enfocadas en encontrar ${isNewsMode ? 'hechos recientes y datos' : 'an√°lisis en profundidad'}. Devuelve solo un JSON con la estructura {"queries": ["query1", ...]}.`;
                const searchGenResponseText = await callGeminiAPI(searchGenPrompt);
                const searchQueries = parseJsonResponse(searchGenResponseText, 'search-queries').queries;

                updateAiButtonState('Buscando...', true);
                const searchPromises = searchQueries.map(q => fetch(`https://www.googleapis.com/customsearch/v1?key=${GOOGLE_SEARCH_API_KEY}&cx=${GOOGLE_SEARCH_CX}&q=${encodeURIComponent(q)}`).then(res => res.json()));
                const searchResults = await Promise.all(searchPromises);
                const searchSnippets = searchResults.flatMap(r => r.items || []).slice(0, 15).map(item => item.snippet).join('\n---\n');

                updateAiButtonState('Planificando...', true);
                const planPrompt = `Basado en esta informaci√≥n sobre "${topic}", crea un plan para un art√≠culo en 3 partes. Devuelve solo un JSON {"part1_instruction": "...", "part2_instruction": "...", "part3_instruction": "..."}. Informaci√≥n: ${searchSnippets}`;
                const planResponseText = await callGeminiAPI(planPrompt);
                const articlePlan = parseJsonResponse(planResponseText, 'plan');
                
                let fullArticleHtml = "";
                for (let i = 1; i <= 3; i++) {
                    updateAiButtonState(`Redactando ${i}/3`, true);
                    const writePrompt = `Escribe la PARTE ${i} de un art√≠culo sobre "${topic}", siguiendo la instrucci√≥n: "${articlePlan[`part${i}_instruction`]}". Contexto: ${fullArticleHtml}. Info: ${searchSnippets}. Devuelve solo HTML.`;
                    const partHtml = await callGeminiAPI(writePrompt);
                    fullArticleHtml += partHtml + "\n";
                }

                updateAiButtonState('Creando detalles...', true);
                const metadataPrompt = `Basado en el texto, genera metadatos. El tono debe ser ${isNewsMode ? 'directo' : 'atractivo'}. Devuelve solo un JSON {"titulo": "...", "resumen": "...", "categoria": "...", "keywords": "3-4 palabras clave para imagen"}. Texto: ${fullArticleHtml}`;
                const metadataResponseText = await callGeminiAPI(metadataPrompt);
                const articleMetadata = parseJsonResponse(metadataResponseText, 'metadata');

                updateAiButtonState('Buscando imagen...', true);
                let imageUrl = `https://placehold.co/600x400/cccccc/ffffff?text=${encodeURIComponent(articleMetadata.categoria)}`;
                const unsplashResponse = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(articleMetadata.keywords)}&per_page=1&orientation=landscape`, {
                    headers: { 'Authorization': `Client-ID ${UNSPLASH_API_KEY}` }
                });
                if (unsplashResponse.ok) {
                    const unsplashData = await unsplashResponse.json();
                    if (unsplashData.results && unsplashData.results.length > 0) {
                        imageUrl = unsplashData.results[0].urls.regular;
                    }
                }
                
                document.getElementById('titulo').value = articleMetadata.titulo;
                document.getElementById('resumen').value = articleMetadata.resumen;
                document.getElementById('categoria').value = articleMetadata.categoria.toUpperCase();
                document.getElementById('contenido').value = fullArticleHtml;
                document.getElementById('imagen').value = imageUrl;
                document.getElementById('autor').value = 'Redacci√≥n IA';

                updateAiButtonState('¬°Listo!', false);
                aiBtnText.textContent = 'Generar';

            } catch (error) {
                alert('Ocurri√≥ un error al generar: ' + error.message);
                updateAiButtonState('Reintentar', false);
            }
        });

        // =================================================================
        // === VIDEO AND AUDIO GENERATION LOGIC ============================
        // =================================================================
        
        let ffmpeg;
        const { createFFmpeg, fetchFile } = FFmpeg;

        async function loadFFmpeg() {
            if (!ffmpeg || !ffmpeg.isLoaded()) {
                videoProgressText.textContent = 'Cargando motor de video (FFmpeg)...';
                ffmpeg = createFFmpeg({ log: true });
                await ffmpeg.load();
            }
        }

        function pcmToWav(base64Pcm, sampleRate) {
            const pcmData = atob(base64Pcm);
            const dataLength = pcmData.length;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = numChannels * bitsPerSample / 8;
            const byteRate = sampleRate * blockAlign;
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            for (let i = 0; i < dataLength; i++) {
                view.setUint8(44 + i, pcmData.charCodeAt(i));
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        async function generateTTS(text) {
            videoProgressText.textContent = 'Generando voz con IA...';
            const prompt = `TTS the following with a clear, engaging, and slightly upbeat news-anchor voice: ${text}`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`TTS API Error: ${(await response.json()).error.message}`);
            const result = await response.json();
            const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;
            if (!audioData) throw new Error("No audio data received from TTS API.");
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
            const wavBlob = pcmToWav(audioData, sampleRate);
            const audioContext = new AudioContext({ sampleRate });
            const audioBuffer = await audioContext.decodeAudioData(await wavBlob.arrayBuffer());
            return { blob: wavBlob, duration: audioBuffer.duration };
        }

        async function generateSilentVideo(imageUrl, duration) {
            videoProgressText.textContent = 'Animando imagen...';
            const WIDTH = 720, HEIGHT = 1280;
            const canvas = document.createElement('canvas');
            canvas.width = WIDTH; canvas.height = HEIGHT;
            const ctx = canvas.getContext('2d');
            const image = new Image();
            image.crossOrigin = "anonymous";
            image.src = imageUrl;
            await new Promise((resolve, reject) => { image.onload = resolve; image.onerror = reject; });
            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
            const chunks = [];
            recorder.ondataavailable = (e) => chunks.push(e.data);
            const recordingPromise = new Promise(resolve => recorder.onstop = () => resolve(new Blob(chunks, { type: 'video/webm' })));
            recorder.start();
            const zoomFactor = 1.2;
            const imgAspectRatio = image.width / image.height;
            const canvasAspectRatio = WIDTH / HEIGHT;
            let initialWidth, initialHeight;
            if (imgAspectRatio > canvasAspectRatio) {
                initialHeight = HEIGHT * zoomFactor;
                initialWidth = initialHeight * imgAspectRatio;
            } else {
                initialWidth = WIDTH * zoomFactor;
                initialHeight = initialWidth / imgAspectRatio;
            }
            const startTime = performance.now();
            function animate(time) {
                const elapsedTime = (time - startTime) / 1000;
                if (elapsedTime > duration) {
                    recorder.stop();
                    return;
                }
                const progress = elapsedTime / duration;
                const currentScale = 1 - 0.1 * progress;
                const newWidth = initialWidth * currentScale;
                const newHeight = initialHeight * currentScale;
                const newX = (WIDTH - newWidth) / 2;
                const newY = (HEIGHT - newHeight) / 2;
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, WIDTH, HEIGHT);
                ctx.drawImage(image, newX, newY, newWidth, newHeight);
                requestAnimationFrame(animate);
            }
            requestAnimationFrame(animate);
            return await recordingPromise;
        }

        async function handleCreateShort(noticia) {
            openVideoModal();
            try {
                await loadFFmpeg();
                const { blob: audioBlob, duration } = await generateTTS(noticia.resumen);
                if (duration > 60) throw new Error("El resumen es demasiado largo para un Short (>60s).");
                const proxiedImageUrl = `https://corsproxy.io/?${encodeURIComponent(noticia.imagen)}`;
                const videoBlob = await generateSilentVideo(proxiedImageUrl, duration);
                videoProgressText.textContent = 'Combinando audio y video...';
                ffmpeg.FS('writeFile', 'video.webm', await fetchFile(videoBlob));
                ffmpeg.FS('writeFile', 'audio.wav', await fetchFile(audioBlob));
                await ffmpeg.run('-i', 'video.webm', '-i', 'audio.wav', '-c:v', 'copy', '-c:a', 'aac', '-shortest', 'output.mp4');
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                videoProgressText.textContent = '¬°Video generado con √©xito!';
                videoLoader.classList.add('hidden');
                videoOutput.innerHTML = `
                    <video controls src="${videoUrl}" class="w-full rounded-lg"></video>
                    <a href="${videoUrl}" download="${slugify(noticia.titulo)}.mp4" 
                       class="mt-4 inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                       Descargar MP4
                    </a>`;
                const downloadLink = document.createElement('a');
                downloadLink.href = videoUrl;
                downloadLink.download = `${slugify(noticia.titulo)}.mp4`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            } catch (error) {
                console.error("Error creating short:", error);
                videoProgressText.textContent = `Error: ${error.message}`;
                videoLoader.classList.add('hidden');
            } finally {
                closeVideoModalBtn.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>

